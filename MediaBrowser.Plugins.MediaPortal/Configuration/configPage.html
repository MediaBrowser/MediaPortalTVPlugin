<!DOCTYPE html>
<html>
<head>
    <title>MediaPortal</title>
</head>
<body>
    <div id="mediaPortalConfigurationPage" data-role="page" class="page type-interior pluginConfigurationPage mediaPortalConfigurationPage" data-require="emby-button,emby-input,emby-select,emby-checkbox,emby-collapse">
        <div data-role="content">
            <div class="content-primary">
                <form id="mediaPortalConfigurationForm">

                    <h1 id="connectionHeader">MediaPortal Connection and Authentication</h1>
                    <div class="inputContainer">
                        <input is="emby-input" id="txtApiHostName" name="txtApiHostName" label="Host name:" />
                        <div class="fieldDescription">
                            The host name (address) of MPExtended Service
                        </div>
                    </div>
                    <div class="inputContainer">
                        <input is="emby-input" id="txtApiPortNumber" name="txtApiPortNumber" label="Port number:" />
                        <div class="fieldDescription">
                            The port number of the MPExtended Service
                        </div>
                    </div>
                    <label class="checkboxContainer">
                        <input is="emby-checkbox" type="checkbox" id="chkRequiresAuthentication" />
                        <span>Requires authentication ("Disabled" is recommended)</span>
                    </label>
                    <div id="txtAuthenticationFields">
                        <div class="inputContainer">
                            <input is="emby-input" id="txtUserName" name="txtUserName" label="User name:" />
                            <div class="fieldDescription">
                                The username specified in MPExtended - Authentication
                            </div>
                        </div>
                        <div class="inputContainer">
                            <input is="emby-input" id="txtPassword" name="txtPassword" label="Password:" />
                            <div class="fieldDescription">
                                The password specified in MPExtended - Authentication
                            </div>
                        </div>
                    </div>
                    <div>
                        <button is="emby-button" type="button" id="saveAndTest" class="raised button-cancel block"><span>Save Connection Settings</span></button>
                    </div>
                    <br />

                    <div is="emby-collapse" title="Channel Options">
                        <div class="collapseContent">
                            <div class="selectContainer">
                                <select is="emby-select" id="selectTvChannelGroup" data-mini="true" label="TV channel group:"></select>
                                <div class="fieldDescription">
                                    Select the tv channel group you wish to use in Emby
                                </div>
                            </div>
                            <div class="selectContainer">
                                <select is="emby-select" id="selectRadioChannelGroup" data-mini="true" label="Radio channel group:"></select>
                                <div class="fieldDescription">
                                    Select the radio channel group you wish to use in Emby
                                </div>
                            </div>
                            <label class="checkboxContainer">
                                <input is="emby-checkbox" type="checkbox" id="chkProgramImages" />
                                <span>Use channel logos as program images</span>
                            </label>
                        </div>
                    </div>

                    <div is="emby-collapse" title="Program and Recording Category Options">
                        <div class="collapseContent">
                            <p>List against each Emby category below, your MediaPortal program guide genres that belong to it</p>
                            <div class="inputContainer">
                                <input is="emby-input" id="txtMovieGenre" name="txtMovieGenre" label="Movie genres:" />
                                <div class="fieldDescription">
                                    Example: Movie,Film,TV Movie
                                </div>
                            </div>
                            <div class="inputContainer">
                                <input is="emby-input" id="txtSeriesGenre" name="txtSeriesGenre" label="Series genres:" />
                                <div class="fieldDescription">
                                    Example: Action Series,Drama (Series),Daily Soap
                                </div>
                            </div>
                            <div class="inputContainer">
                                <input is="emby-input" id="txtSportsGenre" name="txtSportsGenre" label="Sports genres:" />
                                <div class="fieldDescription">
                                    Example: Sport,Football
                                </div>
                            </div>
                            <div class="inputContainer">
                                <input is="emby-input" id="txtNewsGenre" name="txtNewsGenre" label="News or documentary genres:" />
                                <div class="fieldDescription">
                                    Example: News Report,Daily News
                                </div>
                            </div>
                            <div class="inputContainer">
                                <input is="emby-input" id="txtKidsGenre" name="txtKidsGenre" label="Kids genres:" />
                                <div class="fieldDescription">
                                    Example: Cartoon,Animation
                                </div>
                            </div>
                            <div class="inputContainer">
                                <input is="emby-input" id="txtLiveGenre" name="txtLiveGenre" label="Live genres:" />
                                <div class="fieldDescription">
                                    Example: Live Gameshow,Live Sports
                                </div>
                            </div>
                        </div>
                    </div>

                    <div is="emby-collapse" title="Streaming Options">
                        <div class="collapseContent">
                            <label class="checkboxContainer">
                                <input is="emby-checkbox" type="checkbox" id="chkEnableProbing" />
                                <span>Enable stream probing<br />(Needed for audio and subtitle selection. Disabled is much faster and reliable at the cost of CPU resources)</span>
                            </label>
                            <label class="checkboxContainer">
                                <input is="emby-checkbox" type="checkbox" id="chkRtspStreaming" />
                                <span>Use RTSP for live tv streaming</span>
                            </label>
                            <div class="selectContainer">
                                <select is="emby-select" id="selectProfile" label="Streaming profiles:"></select>
                                <div class="fieldDescription">
                                    Select the MPExtended profile to use for streaming (Direct is recommended)
                                </div>
                            </div>
                            <div class="inputContainer">
                                <input is="emby-input" id="txtStreamDelay" name="txtStreamDelay" label="Stream Delay (ms):" />
                                <div id="txtStreamDelayDesc" class="fieldDescription">
                                    Delays returning of the stream url to Emby<br />(Normally zero; Increase for encrypted channels or if Emby does not recognize all audio and subtitles streams)
                                </div>
                            </div>
                        </div>
                    </div>

                    <div is="emby-collapse" title="Recording Options">
                        <div class="collapseContent">
                            <label class="checkboxContainer">
                                <input is="emby-checkbox" type="checkbox" id="chkEnableRecordingImport" />
                                <span>Import recordings from MediaPortal to Emby recording channel<br />(Disable this, if you want to use Emby's DVR library and hide the channel for every user)</span>
                            </label>
                            <div id="txtRecordingOptionsFields">
                                <p><br />Import Options:</p>
                                <label class="checkboxContainer">
                                    <input is="emby-checkbox" type="checkbox" id="chkEnableTmdbLookup" />
                                    <span>Enable TheMovieDatabase online lookup for movie and series recording posters</span>
                                </label>
                                <label class="checkboxContainer">
                                    <input is="emby-checkbox" type="checkbox" id="chkEnableDirectAccess" />
                                    <span>Enable direct access of recording files</span>
                                </label>
                                <div id="txtRequiresPathSubstitutionFields">
                                    <label class="checkboxContainer">
                                        <input is="emby-checkbox" type="checkbox" id="chkRequiresPathSubstitution" />
                                        <span>Direct access of recording files requires pathsubstitution</span>
                                    </label>
                                    <div id="txtPathsubstitutionFields">
                                        <div class="inputContainer">
                                            <input is="emby-input" id="txtLocalFilePath" name="txtLocalFilePath" label="Local path:" />
                                            <div class="fieldDescription">
                                                The local recording folder specified in MediaPortal TVServer settings
                                            </div>
                                        </div>
                                        <div class="inputContainer">
                                            <input is="emby-input" id="txtRemoteFilePath" name="txtRemoteFilePath" label="Remote share:" />
                                            <div class="fieldDescription">
                                                The remote recording share to access MediaPortal recordings
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="inputContainer">
                                    <input is="emby-input" id="txtThumbnailOffset" name="txtThumbnailOffset" label="Recording thumbnail offset (mins):" />
                                    <div class="fieldDescription">
                                        The number of minutes into a programme to capture the screen grab for display
                                    </div>
                                </div>
                            </div>
                            <p><br />Default series timer settings for new schedules:</p>
                            <label class="checkboxContainer">
                                <input is="emby-checkbox" type="checkbox" id="chkEveryTimeOnThisChannel" />
                                <span>Every time on this channel</span>
                            </label>
                            <label class="checkboxContainer">
                                <input is="emby-checkbox" type="checkbox" id="chkEveryTimeOnEveryChannel" />
                                <span>Every time on every channel</span>
                            </label>
                            <label class="checkboxContainer">
                                <input is="emby-checkbox" type="checkbox" id="chkWeeklyEveryTimeOnThisChannel" />
                                <span>Weekly, every time on this channel</span>
                            </label>
                            <label class="checkboxContainer">
                                <input is="emby-checkbox" type="checkbox" id="chkSkipAlreadyInLibrary" />
                                <span>Delete timers if item is already in Emby's library</span>
                            </label>
                            <div class="selectContainer">
                                <select is="emby-select" id="selectSkipAlreadyInLibraryProfile" data-mini="true" label="Compare timers with library items by:"></select>
                            </div>
                            <label class="checkboxContainer">
                                <input is="emby-checkbox" type="checkbox" id="chkAutoCreateTimers" />
                                <span>
                                    Autocreates timers for episodes missing from Emby's library <a href="scheduledtasks.html" id="saveAndLeave">(Click me)</a>
                                    <br />(For this to take affect, you have to enable download of missing episodes in your tv show libraries)
                                </span>
                            </label>
                        </div>
                    </div>

                    <div is="emby-collapse" title="Advanced Options">
                        <div class="collapseContent">
                            <label class="checkboxContainer">
                                <input is="emby-checkbox" type="checkbox" id="chkEnableImageProcessing" />
                                <span>
                                    Enable custom image processing
                                    <br />(Works best with transparent images that have the actual logo size)
                                    <br />No functionality under .MONO installation like for Synology or some other linux distributions!
                                </span>
                            </label>
                            <label class="checkboxContainer">
                                <input is="emby-checkbox" type="checkbox" id="chkEnableLogging" />
                                <span>Enable Logging</span>
                            </label>
                        </div>
                    </div>

                    <br />
                    <div>
                        <button is="emby-button" type="submit" class="raised button-submit block"><span>Save</span></button>
                    </div>

                </form>
            </div>
        </div>

        <script type="text/javascript">

            $("#chkRequiresAuthentication").click(function () {
                checkRequiresAuthentication();
            });

            function checkRequiresAuthentication() {
                if ($("#chkRequiresAuthentication").prop('checked')) {
                    $("#txtAuthenticationFields").show();
                } else {
                    $("#txtAuthenticationFields").hide();
                };
            };


            $("#chkEnableRecordingImport").click(function () {
                checkEnableRecordingImport();
                checkEnableDirectAccess();
                checkRequiresPathSubstitution();
            });

            function checkEnableRecordingImport() {
                if ($("#chkEnableRecordingImport").prop('checked')) {
                    $("#txtRecordingOptionsFields").show();
                } else {
                    $("#txtRecordingOptionsFields").hide();
                };
            };

            $("#chkEnableDirectAccess").click(function () {
                checkEnableDirectAccess();
                checkRequiresPathSubstitution();
            });

            function checkEnableDirectAccess() {
                if ($("#chkEnableRecordingImport").prop('checked') && $("#chkEnableDirectAccess").prop('checked')) {
                    $("#txtRequiresPathSubstitutionFields").show();
                } else {
                    $("#txtRequiresPathSubstitutionFields").hide();
                };
            };

            $("#chkRequiresPathSubstitution").click(function () {
                checkRequiresPathSubstitution();
            });

            function checkRequiresPathSubstitution() {
                if ($("#chkEnableRecordingImport").prop('checked') && $("#chkEnableDirectAccess").prop('checked') && $("#chkRequiresPathSubstitution").prop('checked')) {
                    $("#txtPathsubstitutionFields").show();
                } else {
                    $("#txtPathsubstitutionFields").hide();
                };
            };


            var MediaPortalConfigurationPage = {
                pluginUniqueId: "2c6a0219-7621-4b06-8a64-da3f7038b649"
            };

            $('.mediaPortalConfigurationPage').on('pageinit', function (event) {

                var page = this;

                $("#saveAndTest", page).click(function () {
                    saveConfiguration(page);
                });

                $("#saveAndLeave", page).click(function () {
                    saveConfiguration(page);
                });

                $('form', page).on('submit', function (e) {

                    saveConfiguration(this);

                    return false; // Disable default form submission
                });

            }).on('pageshow', function (event) {

                var page = this;

                $("#connectionTestResult", page).hide();

                Dashboard.showLoadingMsg();

                ApiClient.getPluginConfiguration(MediaPortalConfigurationPage.pluginUniqueId).then(function (config) {

                    $('#txtApiHostName', page).val(config.ApiHostName);
                    $('#txtApiPortNumber', page).val(config.ApiPortNumber);
                    page.querySelector('#chkRequiresAuthentication').checked = config.RequiresAuthentication || false;
                    $('#txtUserName', page).val(config.UserName);
                    $('#txtPassword', page).val(config.Password);
                    page.querySelector('#chkProgramImages').checked = config.ProgramImages || false;
                    page.querySelector('#chkEnableProbing').checked = config.EnableProbing || false;
                    page.querySelector('#chkRtspStreaming').checked = config.RtspStreaming || false;
                    $('#txtStreamDelay', page).val(config.StreamDelay);
                    page.querySelector('#chkEnableRecordingImport').checked = config.EnableRecordingImport || false;
                    page.querySelector('#chkEnableTmdbLookup').checked = config.EnableTmdbLookup || false;
                    page.querySelector('#chkEnableDirectAccess').checked = config.EnableDirectAccess || false;
                    page.querySelector('#chkRequiresPathSubstitution').checked = config.RequiresPathSubstitution || false;
                    $('#txtLocalFilePath', page).val(config.LocalFilePath);
                    $('#txtRemoteFilePath', page).val(config.RemoteFilePath);
                    $('#txtThumbnailOffset', page).val(config.PreviewThumbnailOffsetMinutes);
                    page.querySelector('#chkEveryTimeOnThisChannel').checked = config.EveryTimeOnThisChannel || false;
                    page.querySelector('#chkEveryTimeOnEveryChannel').checked = config.EveryTimeOnEveryChannel || false;
                    page.querySelector('#chkWeeklyEveryTimeOnThisChannel').checked = config.WeeklyEveryTimeOnThisChannel || false;
                    page.querySelector('#chkSkipAlreadyInLibrary').checked = config.SkipAlreadyInLibrary || false;
                    page.querySelector('#chkAutoCreateTimers').checked = config.AutoCreateTimers || false;
                    page.querySelector('#chkEnableImageProcessing').checked = config.EnableImageProcessing || false;
                    page.querySelector('#chkEnableLogging').checked = config.EnableLogging || false;

                    checkRequiresAuthentication();

                    checkEnableRecordingImport();
                    checkEnableDirectAccess();
                    checkRequiresPathSubstitution();

                    loadSelects(config, page);
                    loadGenres(config, page);

                    Dashboard.hideLoadingMsg();
                });
            });

            function loadSelects(config, page) {

                // load in the profiles
                ApiClient.ajax({
                    type: "GET",
                    url: ApiClient.getUrl("MediaPortalPlugin/Profiles"),
                    dataType: "json"
                }).then(function (profiles) {
                    $('#selectProfile', page).html(profiles.map(function (profile) {
                        var selectedText = profile == config.StreamingProfileName ? " selected" : "";
                        return '<option value="' + profile + '"' + selectedText + '>' + profile + '</option>';
                    }));
                });

                ApiClient.ajax({
                    type: "GET",
                    url: ApiClient.getUrl("MediaPortalPlugin/TvChannelGroups"),
                    dataType: "json"
                }).then(function (groups) {
                    $('#selectTvChannelGroup', page).html(groups.map(function (group) {
                        var selectedText = group.Id == config.TvChannelGroup ? " selected" : "";
                        return '<option value="' + group.Id + '"' + selectedText + '>' + group.GroupName + '</option>';
                    }));
                });

                ApiClient.ajax({
                    type: "GET",
                    url: ApiClient.getUrl("MediaPortalPlugin/RadioChannelGroups"),
                    dataType: "json"
                }).then(function (groups) {
                    $('#selectRadioChannelGroup', page).html(groups.map(function (group) {
                        var selectedText = group.Id == config.RadioChannelGroup ? " selected" : "";
                        return '<option value="' + group.Id + '"' + selectedText + '>' + group.GroupName + '</option>';
                    }));
                });

                ApiClient.ajax({
                    type: "GET",
                    url: ApiClient.getUrl("MediaPortalPlugin/SkipAlreadyInLibraryProfiles"),
                    dataType: "json"
                }).then(function (methodes) {
                    $('#selectSkipAlreadyInLibraryProfile', page).html(methodes.map(function (methode) {
                        var selectedText = methode == config.SkipAlreadyInLibraryProfile ? " selected" : "";
                        return '<option value="' + methode + '"' + selectedText + '>' + methode + '</option>';
                    }));
                });

            }

            function loadGenres(config, page) {

                if (config != null && config.GenreMappings) {

                    if (config.GenreMappings["GENREMOVIE"] != null) {
                        $('#txtMovieGenre', page).val(config.GenreMappings["GENREMOVIE"].join(','));
                    }
                    if (config.GenreMappings["GENRESERIES"] != null) {
                        $('#txtSeriesGenre', page).val(config.GenreMappings["GENRESERIES"].join(','));
                    }
                    if (config.GenreMappings["GENRESPORT"] != null) {
                        $('#txtSportsGenre', page).val(config.GenreMappings["GENRESPORT"].join(','));
                    }
                    if (config.GenreMappings["GENRENEWS"] != null) {
                        $('#txtNewsGenre', page).val(config.GenreMappings["GENRENEWS"].join(','));
                    }
                    if (config.GenreMappings["GENREKIDS"] != null) {
                        $('#txtKidsGenre', page).val(config.GenreMappings["GENREKIDS"].join(','));
                    }
                    if (config.GenreMappings["GENRELIVE"] != null) {
                        $('#txtLiveGenre', page).val(config.GenreMappings["GENRELIVE"].join(','));
                    }
                }
            }

            function saveConfiguration(form) {
                Dashboard.showLoadingMsg();

                ApiClient.getPluginConfiguration(MediaPortalConfigurationPage.pluginUniqueId).then(function (config) {

                    config.ApiHostName = $('#txtApiHostName', form).val();
                    config.ApiPortNumber = $('#txtApiPortNumber', form).val();
                    config.RequiresAuthentication = form.querySelector('#chkRequiresAuthentication').checked;
                    config.UserName = $('#txtUserName', form).val();
                    config.Password = $('#txtPassword', form).val();
                    config.TvChannelGroup = $('#selectTvChannelGroup', form).val();
                    config.RadioChannelGroup = $('#selectRadioChannelGroup', form).val();
                    config.ProgramImages = form.querySelector('#chkProgramImages').checked;
                    config.EnableProbing = form.querySelector('#chkEnableProbing').checked;
                    config.RtspStreaming = form.querySelector('#chkRtspStreaming').checked;
                    config.StreamingProfileName = $('#selectProfile', form).val();
                    config.StreamDelay = $('#txtStreamDelay', form).val();
                    config.EnableRecordingImport = form.querySelector('#chkEnableRecordingImport').checked;
                    config.EnableTmdbLookup = form.querySelector('#chkEnableTmdbLookup').checked;
                    config.EnableDirectAccess = form.querySelector('#chkEnableDirectAccess').checked;
                    config.RequiresPathSubstitution = form.querySelector('#chkRequiresPathSubstitution').checked;
                    config.LocalFilePath = $('#txtLocalFilePath', form).val();
                    config.RemoteFilePath = $('#txtRemoteFilePath', form).val();
                    config.PreviewThumbnailOffsetMinutes = $('#txtThumbnailOffset', form).val();
                    config.EveryTimeOnThisChannel = form.querySelector('#chkEveryTimeOnThisChannel').checked;
                    config.EveryTimeOnEveryChannel = form.querySelector('#chkEveryTimeOnEveryChannel').checked;
                    config.WeeklyEveryTimeOnThisChannel = form.querySelector('#chkWeeklyEveryTimeOnThisChannel').checked;
                    config.SkipAlreadyInLibrary = form.querySelector('#chkSkipAlreadyInLibrary').checked;
                    config.SkipAlreadyInLibraryProfile = form.querySelector('#selectSkipAlreadyInLibraryProfile').value;
                    config.AutoCreateTimers = form.querySelector('#chkAutoCreateTimers').checked;
                    config.EnableImageProcessing = form.querySelector('#chkEnableImageProcessing').checked;
                    config.EnableLogging = form.querySelector('#chkEnableLogging').checked;

                    // Copy over the genre mapping fields
                    config.GenreMappings = {
                        "GENREMOVIE": $('#txtMovieGenre', form).val().split(","),
                        "GENRESERIES": $('#txtSeriesGenre', form).val().split(","),
                        "GENRESPORT": $('#txtSportsGenre', form).val().split(","),
                        "GENRENEWS": $('#txtNewsGenre', form).val().split(","),
                        "GENREKIDS": $('#txtKidsGenre', form).val().split(","),
                        "GENRELIVE": $('#txtLiveGenre', form).val().split(","),
                    };

                    ApiClient.updatePluginConfiguration(MediaPortalConfigurationPage.pluginUniqueId, config).then(function () {

                        // Reload the selects - this may be called by the 'test' button
                        loadSelects(config, form);

                        Dashboard.processPluginConfigurationUpdateResult();
                    });

                });

                Dashboard.hideLoadingMsg();
            }

        </script>

    </div>
</body>
</html>